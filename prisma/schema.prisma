generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Campaign {
  id          String   @id @default(cuid())
  worldId     String
  name        String   @db.VarChar(120)
  roomCode    String   @unique @db.VarChar(12)
  system      String   @default("TORMENTA_20") @db.VarChar(40)
  rulesetId   String   @default("tormenta20") @db.VarChar(50)
  description String?  @db.VarChar(500)
  status      String   @default("ACTIVE") @db.VarChar(12) // ACTIVE, ARCHIVED, DELETED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  world       World        @relation(fields: [worldId], references: [id], onDelete: Cascade)
  characters  Character[]
  npcs        Npc[]
  sessions    Session[]
  combat      Combat?
  worldEvents WorldEvent[]
  mapTokens   MapToken[]
  mapPins     MapPin[]

  @@index([worldId])
}

enum WorldStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum WorldMemberRole {
  GM
  PLAYER
  SPECTATOR
}

model WorldMember {
  id        String          @id @default(cuid())
  worldId   String
  userId    String          @db.VarChar(120) // Clerk/Auth ID
  role      WorldMemberRole @default(PLAYER)
  createdAt DateTime        @default(now())
  
  world     World           @relation(fields: [worldId], references: [id], onDelete: Cascade)

  @@unique([worldId, userId])
  @@index([userId])
}

model World {
  id          String      @id @default(cuid())
  ownerId     String?     @db.VarChar(120) // Creator/Owner
  title       String      @db.VarChar(200)
  description String?     @db.VarChar(1000)
  coverImage  String?     @db.VarChar(500)
  status      WorldStatus @default(ACTIVE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  members          WorldMember[]
  campaigns        Campaign[]
  events           WorldEvent[]
  characters       Character[]
  npcs             Npc[]
  sessions         Session[]
  sessionSummaries SessionSummary[]
  rulesetDocuments RulesetDocument[]
}

enum WorldEventScope {
  MICRO
  MACRO
}

enum WorldEventVisibility {
  MASTER
  PLAYERS
}

enum WorldEventType {
  // Metagame / Lifecycle
  WORLD_CREATED
  CAMPAIGN_CREATED
  CHARACTER_CREATED
  
  // Gameplay
  ATTACK
  DAMAGE
  SPELL
  SKILL
  NOTE
  NPC_MENTION
  ITEM_MENTION
  OVERRIDE
  TURN
  INITIATIVE
  SESSION_START
  SESSION_END
  LOCATION_DISCOVERY
  NPC_DEATH
  WORLD_CHANGE
  CONDITION_APPLIED
  CONDITION_REMOVED
  
  // New Combat Lifecycle
  COMBAT_STARTED
  COMBAT_ENDED
  ROLL
}

model WorldEvent {
  id         String               @id @default(cuid())
  worldId    String
  campaignId String?
  sessionId  String?
  combatId   String?
  
  type       WorldEventType
  scope      WorldEventScope
  impactLevel Int             @default(1) // 1=Micro, <=2 Micro, >=4 Macro
  
  // Canonical event data
  payload    Json?
  
  ts         DateTime             @default(now())
  
  // Metadata for querying/indexing
  actorId    String?              @db.VarChar(120)
  targetId   String?              @db.VarChar(120)
  visibility WorldEventVisibility @default(PLAYERS)
  
  // Legacy/Optional fields (kept for compatibility or specific specific usage)
  breakdown  Json?
  meta       Json?
  text       String?              @db.VarChar(500)

  world    World     @relation(fields: [worldId], references: [id])
  campaign Campaign? @relation(fields: [campaignId], references: [id])

  @@index([worldId, ts])
  @@index([campaignId, ts])
  @@index([type])
}

model Character {
  id          String   @id @default(cuid())
  campaignId  String
  worldId     String
  name        String   @db.VarChar(120)
  ancestry    String?  @db.VarChar(120)
  className   String?  @db.VarChar(120)
  role        String?  @db.VarChar(120)
  description String?  @db.VarChar(500)
  avatarUrl   String?  @db.VarChar(500)
  level       Int      @default(1)
  attributes  Json?    // { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0 }
  skills      Json?    // { fight: 5, perception: 2 }
  stats       Json?    // { hp: { current: 10, max: 10 }, pm: { ... } }
  spells      Json?    // List of known spells
  inventory   Json?    // List of items
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaign Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  world    World           @relation(fields: [worldId], references: [id], onDelete: Cascade)
  sheet    CharacterSheet?

  @@index([campaignId])
  @@index([worldId])
}

model Reveal {
  id         String    @id @default(cuid())
  roomCode   String    @db.VarChar(12)
  type       String    @db.VarChar(12)
  title      String    @db.VarChar(180)
  content    Json
  imageUrl   String?   @db.VarChar(500)
  visibility String    @default("players") @db.VarChar(16)
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?

  @@index([roomCode, createdAt])
}

model CharacterSheet {
  id             String  @id @default(cuid())
  characterId    String  @unique
  sheetRulesetId String  @default("tormenta20") @db.VarChar(50)
  level          Int     @default(1)
  className      String? @db.VarChar(120)
  ancestry       String? @db.VarChar(120)
  deity          String? @db.VarChar(120)
  for            Int     @default(10)
  des            Int     @default(10)
  con            Int     @default(10)
  int            Int     @default(10)
  sab            Int     @default(10)
  car            Int     @default(10)
  pvCurrent      Int     @default(0)
  pvMax          Int     @default(0)
  pmCurrent      Int     @default(0)
  pmMax          Int     @default(0)
  attackBonus    Int     @default(0)
  damageFormula  String  @default("1d6")
  critRange      Int     @default(20)
  critMultiplier Int     @default(2)
  defenseFinal   Int     @default(10)
  defenseRef     Int     @default(0)
  defenseFort    Int     @default(0)
  defenseWill    Int     @default(0)
  skills         Json?
  attacks        Json?
  spells         Json?
  notes          String?

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
}

model Combat {
  id         String   @id @default(cuid())
  campaignId String   @unique
  isActive   Boolean  @default(true)
  round      Int      @default(1)
  turnIndex  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaign   Campaign           @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  combatants Combatant[]
  events     CombatEvent[]
  conditions AppliedCondition[]
}

model Combatant {
  id              String   @id @default(cuid())
  combatId        String
  kind            String   @db.VarChar(16)
  refId           String   @db.VarChar(120)
  name            String   @db.VarChar(200)
  initiative      Int      @default(0)
  hpCurrent       Int      @default(0)
  hpMax           Int      @default(0)
  mpCurrent       Int      @default(0)
  mpMax           Int      @default(0)
  defenseFinal    Int      @default(10)
  attackBonus     Int      @default(0)
  damageFormula   String   @default("1d6") @db.VarChar(50)
  isPlayerVisible Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  combat            Combat             @relation(fields: [combatId], references: [id], onDelete: Cascade)
  appliedConditions AppliedCondition[]

  @@index([combatId])
}

model CombatEvent {
  id          String   @id @default(cuid())
  combatId    String
  ts          DateTime @default(now())
  actorName   String   @db.VarChar(200)
  type        String   @db.VarChar(16)
  payloadJson Json
  visibility  String   @default("PLAYERS") @db.VarChar(12)

  combat            Combat             @relation(fields: [combatId], references: [id], onDelete: Cascade)
  appliedConditions AppliedCondition[]

  @@index([combatId, ts])
}

model Condition {
  id          String   @id @default(cuid())
  rulesetId   String   @db.VarChar(50)
  key         String   @db.VarChar(80)
  name        String   @db.VarChar(180)
  description String?  @db.VarChar(500)
  effectsJson Json
  createdAt   DateTime @default(now())

  applied AppliedCondition[]

  @@unique([rulesetId, key])
  @@index([rulesetId])
}

model AppliedCondition {
  id                String   @id @default(cuid())
  combatId          String
  targetCombatantId String
  conditionId       String
  sourceEventId     String?
  expiresAtTurn     Int?
  createdAt         DateTime @default(now())

  combat      Combat       @relation(fields: [combatId], references: [id], onDelete: Cascade)
  target      Combatant    @relation(fields: [targetCombatantId], references: [id], onDelete: Cascade)
  condition   Condition    @relation(fields: [conditionId], references: [id], onDelete: Restrict)
  sourceEvent CombatEvent? @relation(fields: [sourceEventId], references: [id], onDelete: SetNull)

  @@index([combatId])
  @@index([targetCombatantId])
  @@index([conditionId])
  @@index([sourceEventId])
}

model RulesetDocument {
  id         String   @id @default(cuid())
  rulesetId  String   @db.VarChar(50)
  worldId    String
  title      String   @db.VarChar(200)
  type       String   @db.VarChar(32)
  filePath   String   @db.VarChar(500)
  storageKey String   @db.VarChar(500)
  pages      Int?
  textIndex  String?
  createdAt  DateTime @default(now())

  world World @relation(fields: [worldId], references: [id], onDelete: Cascade)

  @@index([rulesetId, createdAt])
  @@index([title])
  @@index([worldId])
}

model SessionSummary {
  id         String   @id @default(cuid())
  sessionId  String   @db.VarChar(120)
  campaignId String?  @db.VarChar(120)
  worldId    String
  summary    String   @db.Text
  highlights Json?
  npcs       Json?
  items      Json?
  hooks      Json?
  createdAt  DateTime @default(now())

  world World @relation(fields: [worldId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([campaignId, createdAt])
  @@index([worldId])
}

model Session {
  id          String    @id @default(cuid())
  campaignId  String
  worldId     String
  title       String    @db.VarChar(200)
  description String?   @db.VarChar(1000)
  coverUrl    String?   @db.VarChar(500)
  scheduledAt DateTime?
  status      String    @default("planned") @db.VarChar(16)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  world    World    @relation(fields: [worldId], references: [id], onDelete: Cascade)

  @@index([campaignId, scheduledAt])
  @@index([worldId])
}

model Npc {
  id            String   @id @default(cuid())
  campaignId    String
  worldId       String
  name          String   @db.VarChar(120)
  type          String   @default("npc") @db.VarChar(12)
  hpMax         Int      @default(1)
  defenseFinal  Int      @default(10)
  damageFormula String   @default("1d6") @db.VarChar(50)
  description   String?  @db.VarChar(1000)
  tags          String?  @db.VarChar(500)
  imageUrl      String?  @db.VarChar(500)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  world    World    @relation(fields: [worldId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([worldId])
}

model ActionRequest {
  id         String   @id @default(cuid())
  campaignId String   @db.VarChar(120)
  combatId   String?  @db.VarChar(120)
  roomCode   String?  @db.VarChar(16)
  actorId    String   @db.VarChar(120)
  targetId   String   @db.VarChar(120)
  type       String   @db.VarChar(20)
  payload    Json
  status     String   @default("PENDING") @db.VarChar(16)
  createdAt  DateTime @default(now())

  @@index([roomCode, status, createdAt])
}

model MapToken {
  id          String   @id @default(cuid())
  campaignId  String
  x           Float
  y           Float
  scale       Float    @default(1)
  rotation    Float    @default(0)
  type        String   @default("character") // character, enemy, prop
  referenceId String?  // ID of the character/npc if linked
  imageUrl    String?
  label       String?
  status      String?  // active, defeated, hidden
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

model MapPin {
  id          String   @id @default(cuid())
  campaignId  String
  x           Float
  y           Float
  type        String   @default("poi") // poi, danger, secret, loot
  title       String?
  description String?
  color       String?  @default("#ffffff")
  visible     Boolean  @default(true)
  createdAt   DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}

model AiChatSession {
  id         String   @id @default(cuid())
  userId     String   @db.VarChar(120) // Clerk/Auth ID
  campaignId String?
  worldId    String?
  title      String   @db.VarChar(200)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  messages AiChatMessage[]

  @@index([userId])
  @@index([campaignId])
}

model AiChatMessage {
  id        String        @id @default(cuid())
  sessionId String
  role      String        @db.VarChar(16) // user, assistant, system
  content   String        @db.Text
  intent    String?       @db.VarChar(50) // ROLL, ATTACK, etc
  meta      Json?         // Parsed parameters, execution result
  createdAt DateTime      @default(now())

  session AiChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}
